{% extends 'base.html' %}
{% set page_title = 'My Profile' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid p-0 profile-hero">
  <div class="profile-cover"></div>
  <div class="container position-relative">
    <div class="profile-identity">
      <div class="avatar-wrapper">
        {% if user.profile_picture %}
        {% set pic = user.profile_picture %}
        {% set pic_path = pic if pic.startswith('images/') or pic.startswith('uploads/') else 'uploads/' ~ pic %}
        <img class="avatar-img" alt="Profile image" src="{{ url_for('static', filename=pic_path) }}">
        {% else %}
        <div class="avatar-fallback">{{ (user.name or user.username)[:1]|upper }}</div>
        {% endif %}
      </div>
      <div style="flex:1; padding-bottom:8px;">
        <h2 class="mb-2">{{ user.name or user.username }}</h2>
        <div class="text-white-80 mb-2">
          <i class="fas fa-envelope me-2"></i>{{ user.email }}
        </div>
        <div class="text-white-80 mb-2">
          <i class="fas fa-calendar-alt me-2"></i>Joined {{ user.created_at.strftime('%B %d, %Y') if user.created_at else 'Recently' }}
        </div>
        {% if user.role %}
        <span class="badge bg-glass"><i class="fas fa-user-tag me-1"></i>{{ user.role.name|title }}</span>
        {% endif %}
      </div>
      <div class="profile-actions" style="padding-bottom:8px;">
        <a href="{{ url_for('auth.edit_profile') }}" class="btn btn-light btn-sm">
          <i class="fas fa-edit me-1"></i> Edit Profile
        </a>
        <a href="{{ url_for('auth.change_password') }}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-key me-1"></i> Change Password
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container py-4">
  <div class="row g-4">
    <!-- Stats Cards -->
    <div class="col-6 col-md-3">
      <div class="card stat-gradient stat-1 h-100">
        <div class="card-body">
          <i class="fas fa-feather stat-icon"></i>
          <div class="stat-value">{{ post_count }}</div>
          <div class="stat-label">Blog Posts</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card stat-gradient stat-2 h-100">
        <div class="card-body">
          <i class="fas fa-heart stat-icon"></i>
          <div class="stat-value">{{ like_count }}</div>
          <div class="stat-label">Likes</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card stat-gradient stat-3 h-100">
        <div class="card-body">
          <i class="fas fa-comments stat-icon"></i>
          <div class="stat-value">{{ forum_threads }}</div>
          <div class="stat-label">Threads</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card stat-gradient stat-4 h-100">
        <div class="card-body">
          <i class="fas fa-reply stat-icon"></i>
          <div class="stat-value">{{ forum_replies }}</div>
          <div class="stat-label">Replies</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Info and Activity -->
  <div class="row mt-4 g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm h-100 profile-info-card">
        <div class="card-header bg-white d-flex align-items-center">
          <strong><i class="fas fa-user-circle me-2 text-success"></i>Profile Information</strong>
          <a href="{{ url_for('auth.edit_profile') }}" class="btn btn-sm btn-success ms-auto"><i class="fas fa-pencil-alt me-1"></i>Edit</a>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span><i class="fas fa-user text-success me-2"></i>FULL NAME</span>
            <span class="info-value">{{ user.name or '—' }}</span>
          </div>
          <div class="info-row">
            <span><i class="fas fa-at text-success me-2"></i>USERNAME</span>
            <span class="info-value">{{ user.username }}</span>
          </div>
          <div class="info-row">
            <span><i class="fas fa-envelope text-success me-2"></i>EMAIL</span>
            <span class="info-value">{{ user.email }}</span>
          </div>
          <div class="info-row">
            <span><i class="fas fa-mobile-alt text-success me-2"></i>MOBILE</span>
            <span class="info-value">{{ user.mobile or '—' }}</span>
          </div>
          {% if user.profession %}
          <div class="info-row">
            <span><i class="fas fa-briefcase text-success me-2"></i>PROFESSION</span>
            <span class="info-value">{{ user.profession|title }}</span>
          </div>
          {% endif %}
          <div class="info-row">
            <span><i class="fas fa-chart-line text-success me-2"></i>EXPERTISE LEVEL</span>
            <span class="info-value">{{ user.expertise_level|title if user.expertise_level else '—' }}</span>
          </div>
          {% if user.city or user.state or user.country %}
          <div class="info-row">
            <span><i class="fas fa-map-marker-alt text-success me-2"></i>LOCATION</span>
            <span class="info-value">{{ (user.city ~ ', ') if user.city }}{{ (user.state ~ ', ') if user.state }}{{ user.country or '' }}</span>
          </div>
          {% endif %}
          {% if user.specialization %}
          <div class="info-row">
            <span><i class="fas fa-star text-success me-2"></i>SPECIALIZATION</span>
            <span class="info-value">{{ user.specialization }}</span>
          </div>
          {% endif %}
          {% if user.bio %}
          <div class="mt-3 bio-section">
            <div class="text-muted small mb-2 fw-bold"><i class="fas fa-align-left text-success me-2"></i>BIO</div>
            <div class="bio-text">{{ user.bio }}</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="row g-4">
        <!-- Latest Blog Posts -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <strong>Latest Blog Posts</strong>
              <a href="{{ url_for('blog.index') }}" class="btn btn-sm btn-outline-success">All Blogs</a>
            </div>
            <ul class="list-group list-group-flush">
              {% for post in latest_blog_posts %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <a href="{{ url_for('blog.post_detail', post_id=post.id, slug=post.slug) }}" class="fw-medium">{{ post.title }}</a>
                  <div class="text-muted small">{{ post.published_at.strftime('%Y-%m-%d') if post.published_at else post.created_at.strftime('%Y-%m-%d') }}</div>
                </div>
                <span class="badge bg-success">{{ post.like_count or 0 }} Likes</span>
              </li>
              {% else %}
              <li class="list-group-item text-muted">No recent blog posts.</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Latest Forum Threads -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <strong>Latest Forum Threads</strong>
              <a href="{{ url_for('forum.index') }}" class="btn btn-sm btn-outline-success">Forum</a>
            </div>
            <ul class="list-group list-group-flush">
              {% for thread in latest_threads %}
              <li class="list-group-item">
                <a href="{{ url_for('forum.thread_detail', thread_id=thread.id, slug=thread.slug) }}" class="fw-medium">{{ thread.title }}</a>
                <div class="text-muted small">Last activity: {{ thread.last_activity.strftime('%Y-%m-%d') }}</div>
              </li>
              {% else %}
              <li class="list-group-item text-muted">No recent forum threads.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
