{% extends "base.html" %}
{% block title %}{{ product.name }}{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/marketplace.css') }}">{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-5">
    <div class="product-card">
      {% if product.image_url %}
      <img src="{{ url_for('static', filename=product.image_url) }}" alt="{{ product.name }} - {{ product.category }}" class="img-fluid mb-3" style="max-height:300px;object-fit:cover;width:100%;">
      {% else %}
      <img src="{{ url_for('static', filename='img/backgrounds/product-placeholder.jpg') }}" alt="{{ product.name }} - No image available" class="img-fluid mb-3" style="max-height:300px;object-fit:cover;width:100%;">
      {% endif %}
      <div class="product-title">{{ product.name }}</div>
      <div class="product-price">Rs. {{ product.price }}</div>
      {% if product.original_price and product.get_discount_percentage() > 0 %}
      <p class="small text-muted"><del>Rs. {{ product.original_price }}</del> <span class="text-success">{{ product.get_discount_percentage() }}% off</span></p>
      {% endif %}
      <p class="small text-muted mb-1"><strong>Stock:</strong> {{ product.stock_quantity }} {{ product.unit or 'units' }}</p>
      <p class="small text-muted mb-1"><strong>Category:</strong> {{ product.category }}</p>
      {% if product.brand %}
      <p class="small text-muted mb-1"><strong>Brand:</strong> {{ product.brand }}</p>
      {% endif %}
      {% if product.rating > 0 %}
      <p class="small mb-2">⭐ {{ product.rating }}/5.0 ({{ product.review_count }} reviews)</p>
      {% endif %}
      <p class="mt-2">{{ product.description or 'No description available.' }}</p>
      
      {% if current_user.is_authenticated %}
      <form method="POST" action="{{ url_for('marketplace.cart_add', product_id=product.id) }}" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="input-group mb-2">
          <input type="number" name="quantity" value="1" min="1" max="{{ product.stock_quantity }}" class="form-control" style="max-width:100px;">
          <button type="submit" class="cart-btn">Add to Cart</button>
        </div>
      </form>
      {% else %}
      <div class="alert alert-info mt-3">
        <a href="{{ url_for('auth.login') }}">Login</a> to purchase this product.
      </div>
      {% endif %}
    </div>
  </div>
  
  <div class="col-12 col-lg-7">
    <div class="product-card">
      <h5>Seller Information</h5>
      <p class="mb-1"><strong>{{ product.vendor.name if product.vendor else 'Unknown Seller' }}</strong></p>
      <p class="small text-muted mb-3">{{ product.vendor.city or 'Sindh' }}, {{ product.vendor.country or 'Pakistan' }}</p>
      
      {% if reviews %}
      <h6 class="mt-4">Customer Reviews</h6>
      {% for review in reviews %}
      <div class="border-bottom pb-2 mb-2">
        <p class="mb-1"><strong>{{ review.user.name if review.user else 'Anonymous' }}</strong> - ⭐ {{ review.rating }}/5</p>
        <p class="small mb-0">{{ review.comment }}</p>
      </div>
      {% endfor %}
      {% endif %}
      
      {% if current_user.is_authenticated %}
      <h6 class="mt-4">Leave a Review</h6>
      <form method="POST" action="{{ url_for('marketplace.product_review', product_id=product.id) }}">
        {{ review_form.hidden_tag() }}
        <div class="mb-2">
          <label class="form-label small">Rating</label>
          {{ review_form.rating(class="form-select form-select-sm", style="max-width:150px;") }}
        </div>
        <div class="mb-2">
          <label class="form-label small">Comment</label>
          {{ review_form.comment(class="form-control form-control-sm", rows="3") }}
        </div>
        <button type="submit" class="btn btn-success btn-sm">Submit Review</button>
      </form>
      {% endif %}
    </div>
    
    {% if related_products %}
    <div class="product-card mt-3">
      <h6>Related Products</h6>
      <ul class="mb-0">
        {% for r in related_products %}
        <li class="mb-1"><a href="{{ url_for('marketplace.product', product_id=r.id) }}" class="text-decoration-none">{{ r.name }} - Rs. {{ r.price }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}