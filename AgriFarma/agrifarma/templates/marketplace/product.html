{% extends "layouts/base.html" %}
{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col-md-6">
      <img src="{{ product.image_url or '/static/images/Backgrounds/pexels-quang-nguyen-vinh-222549-2131784.jpg' }}" class="img-fluid rounded maxh-380 object-cover w-100" alt="{{ product.name }}">
    </div>
    <div class="col-md-6">
      <h2>{{ product.name }}</h2>
      {% if product.get_discount_percentage() %}
        <div>
          <span class="badge badge-success">{{ product.get_discount_percentage() }}% Off</span>
        </div>
      {% endif %}
      <p class="text-muted mb-1">Category: {{ product.category }}</p>
      <p class="lead">{{ 'PKR ' ~ '%.2f'|format(product.price) }}
         {% if product.original_price and product.original_price > product.price %}
            <small class="text-muted"><del>{{ 'PKR ' ~ '%.2f'|format(product.original_price) }}</del></small>
         {% endif %}
      </p>
      <p>{{ product.description or 'No description provided.' }}</p>
      <form method="post" action="{{ url_for('marketplace.cart_add', product_id=product.id) }}" class="row g-2 align-items-center mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="col-auto">
          <input type="number" name="quantity" value="1" min="1" max="{{ product.stock_quantity }}" class="form-control w-120" >
        </div>
        <div class="col-auto">
        <button type="submit" class="btn btn-primary" {% if product.stock_quantity <= 0 %}disabled{% endif %}>Add to Cart</button>
        </div>
      </form>
      {% if product.stock_quantity <= 0 %}
        <p class="text-danger">Out of stock</p>
      {% else %}
        <p class="text-success">In stock: {{ product.stock_quantity }}</p>
      {% endif %}
    </div>
  </div>
  <hr>
  <div class="row mt-4">
    <div class="col-md-8">
      <h4>Reviews ({{ product.review_count or 0 }})</h4>
      {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('marketplace.product_review', product_id=product.id) }}" class="mb-3">
        {{ review_form.hidden_tag() }}
        <div class="form-row">
          <div class="col-md-2">{{ review_form.rating.label }} {{ review_form.rating(class='form-control w-120') }}</div>
          <div class="col-md-8">{{ review_form.comment(class='form-control', placeholder='Share your experience') }}</div>
          <div class="col-md-2 d-flex align-items-end">{{ review_form.submit(class='btn btn-sm btn-success') }}</div>
        </div>
      </form>
      {% else %}
        <p><a href="{{ url_for('auth.login') }}">Log in</a> to write a review.</p>
      {% endif %}
      {% for r in reviews %}
        <div class="border rounded p-2 mb-2">
          <strong>{{ r.user.username }}</strong>
          <span class="text-warning">{{ '★' * r.rating }}{{ '☆' * (5 - r.rating) }}</span>
          <small class="text-muted">{{ r.created_at|datetime }}</small>
          <p class="mb-0">{{ r.comment }}</p>
        </div>
      {% else %}
        <p class="text-muted">No reviews yet.</p>
      {% endfor %}
    </div>
    <div class="col-md-4">
      <h5>Related Products</h5>
      {% for rp in related %}
        <div class="media mb-2">
          <img src="{{ rp.image_url }}" class="mr-2 w-64 h-64 object-cover rounded" alt="{{ rp.name }}">
          <div class="media-body">
            <a href="{{ url_for('marketplace.product', product_id=rp.id) }}">{{ rp.name }}</a>
            <div class="small text-muted">PKR {{ '%.2f'|format(rp.price) }}</div>
          </div>
        </div>
      {% else %}
        <p class="text-muted">No related products.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
